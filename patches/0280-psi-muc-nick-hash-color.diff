Entering 'iris'
Entering 'src/libpsi'
Index: psi/options/default.xml
===================================================================
--- psi.orig/options/default.xml	2013-01-15 14:04:04.604826150 +0400
+++ psi/options/default.xml	2013-01-15 14:04:04.600826150 +0400
@@ -219,7 +219,7 @@
 					<width>580</width>
 					<height>420</height>
 				</size>
-				<use-highlighting type="bool">true</use-highlighting><use-nick-coloring type="bool">true</use-nick-coloring>
+				<use-highlighting type="bool">true</use-highlighting><use-nick-coloring type="bool">true</use-nick-coloring><use-hash-nick-coloring type="bool">true</use-hash-nick-coloring><colored-history type="bool">true</colored-history>
 			</muc>
 			<show-deprecated comment="Deprecated functionality or protocols">
 				<service-discovery comment="Service discovery dialog">
Index: psi/src/chatview_te.cpp
===================================================================
--- psi.orig/src/chatview_te.cpp	2013-01-15 14:04:04.604826150 +0400
+++ psi/src/chatview_te.cpp	2013-01-15 14:04:04.600826150 +0400
@@ -290,7 +290,7 @@
 		alerttagsc = "</b>";
 	}

-	if(mv.isSpooled()) {
+	if(mv.isSpooled() && !PsiOptions::instance()->getOption("options.ui.muc.colored-history").toBool()) {
 		nickcolor = ColorOpt::instance()->color(infomrationalColorOpt).name();
 	} else {
 		nickcolor = getMucNickColor(mv.nick(), mv.isLocal());
Index: psi/src/chatviewcommon.h
===================================================================
--- psi.orig/src/chatviewcommon.h
+++ psi/src/chatviewcommon.h
@@ -41,8 +41,11 @@ protected:
 	QDateTime _lastMsgTime;
 
 private:
+	void generatePalette();
+	bool compatibleColors(const QColor &, const QColor &);
 	int _nickNumber;
 	QMap<QString,int> _nicks;
+	QList<QColor> _palette;
 };
 
 #endif
Index: psi/src/chatviewcommon.cpp
===================================================================
--- psi.orig/src/chatviewcommon.cpp
+++ psi/src/chatviewcommon.cpp
@@ -18,7 +18,12 @@
  *
  */
 
+#include <QApplication>
 #include <QWidget>
+#include <QColor>
+#include <QRegExp>
+
+#include <math.h>
 
 #include "chatviewcommon.h"
 #include "psioptions.h"
@@ -42,30 +47,91 @@ bool ChatViewCommon::updateLastMsgTime(QDateTime t)
 
 QString ChatViewCommon::getMucNickColor(const QString &nick, bool isSelf, QStringList validList)
 {
+	const char* rgbBlack = "#000000";
+	QString nickwoun = nick; // nick without underscores
+	nickwoun.replace(QRegExp("^_*"), "");
+	nickwoun.replace(QRegExp("_*$"), "");
+
 	int sender;
-	if(isSelf || nick.isEmpty()) {
+	if(isSelf || nickwoun.isEmpty()) {
 		sender = -1;
 	} else {
-		if (!_nicks.contains(nick)) {
+		if (!_nicks.contains(nickwoun)) {
 			//not found in map
-			_nicks.insert(nick,_nickNumber);
+			_nicks.insert(nickwoun,_nickNumber);
 			_nickNumber++;
 		}
-		sender=_nicks[nick];
+		sender=_nicks[nickwoun];
 	}
 
 	QStringList nickColors = validList.isEmpty()
 		? PsiOptions::instance()->getOption("options.ui.look.colors.muc.nick-colors").toStringList()
 		: validList;
 
-	if(!PsiOptions::instance()->getOption("options.ui.muc.use-nick-coloring").toBool() || nickColors.empty()) {
-		return "#000000";
+	if(!PsiOptions::instance()->getOption("options.ui.muc.use-nick-coloring").toBool()) {
+		return rgbBlack;
+	} else {
+		if (PsiOptions::instance()->getOption("options.ui.muc.use-hash-nick-coloring").toBool()) {
+			/* Hash-driven colors */
+			Q_ASSERT(nickwoun.size());
+			quint32 hash = qHash(nickwoun); // almost unique hash
+			if (_palette.isEmpty()) {
+				generatePalette();
+			}
+			const QColor &precolor = _palette.at(hash % _palette.size());
+			return precolor.name();
+		} else {
+			/* Colors from list */
+			if (nickColors.empty()) {
+				return rgbBlack;
+			}
+			if(sender == -1 || nickColors.size() == 1) {
+				return nickColors[nickColors.size()-1];
+			} else {
+				int n = sender % (nickColors.size()-1);
+				return nickColors[n];
+			}
+		}
+	}
+}
+
+void ChatViewCommon::generatePalette()
+{
+	QColor bg = qApp->palette().color(QPalette::Base); // background color
+	QList<QColor> result;
+	QColor color;
+	for (int k = 0; k < 10 ; ++k) {
+		color = QColor::fromHsv(36*k, 255, 255);
+		if (compatibleColors(color, bg)) {
+			result << color;
+		}
+		color = QColor::fromHsv(36*k, 255, 170);
+		if (compatibleColors(color, bg)) {
+			result << color;
+		}
+	}
+	_palette = result;
+}
+
+bool ChatViewCommon::compatibleColors(const QColor &c1, const QColor &c2)
+{
+	int dR = c1.red()-c2.red();
+	int dG = c1.green()-c2.green();
+	int dB = c1.blue()-c2.blue();
+
+	double dV = abs(c1.value()-c2.value());
+	double dC = sqrt(0.2126*dR*dR + 0.7152*dG*dG + 0.0722*dB*dB);
+
+	if (dC < 80. && dV > 100) {
+		return false;
 	}
-	else if(sender == -1 || nickColors.size() == 1) {
-		return nickColors[nickColors.size()-1];
+	else if (dC < 110. && dV <= 100 && dV > 10) {
+		return false;
 	}
-	else {
-		int n = sender % (nickColors.size()-1);
-		return nickColors[n];
+	else if (dC < 125. && dV <= 10) {
+		return false;
 	}
+
+	return true;
 }
+
Index: psi/src/options/opt_general_groupchat.ui
===================================================================
--- psi.orig/src/options/opt_general_groupchat.ui	2013-01-15 14:04:04.604826150 +0400
+++ psi/src/options/opt_general_groupchat.ui	2013-01-15 14:04:04.604826150 +0400
@@ -157,6 +157,13 @@
        </property>
       </widget>
      </item>
+      <item>
+      <widget class="QCheckBox" name="ck_gcHashNickColoring" >
+       <property name="text" >
+        <string>Enable hash nick coloring</string>
+       </property>
+      </widget>
+     </item>
      <item>
       <widget class="QGroupBox" name="ncGroupBox" >
        <property name="title" >
@@ -296,11 +303,30 @@
   <tabstop>pb_removeHighlightWord</tabstop>
   <tabstop>pb_addHighlightWord</tabstop>
   <tabstop>ck_gcNickColoring</tabstop>
+  <tabstop>ck_gcHashNickColoring</tabstop>
   <tabstop>le_newNickColor</tabstop>
   <tabstop>pb_nickColor</tabstop>
   <tabstop>pb_removeNickColor</tabstop>
   <tabstop>pb_addNickColor</tabstop>
  </tabstops>
  <resources/>
- <connections/>
-</ui>
+ <connections>
+  <connection>
+   <sender>ck_gcNickColoring</sender>
+   <signal>toggled(bool)</signal>
+   <receiver>ck_gcHashNickColoring</receiver>
+   <slot>setEnabled(bool)</slot>
+   <hints>
+    <hint type="sourcelabel">
+     <x>326</x>
+     <y>18</y>
+    </hint>
+    <hint type="destinationlabel">
+     <x>326</x>
+     <y>42</y>
+    </hint>
+   </hints>
+  </connection>
+ </connections>
+ </ui>
+
Index: psi/src/options/opt_groupchat.cpp
===================================================================
--- psi.orig/src/options/opt_groupchat.cpp	2013-01-15 14:04:04.604826150 +0400
+++ psi/src/options/opt_groupchat.cpp	2013-01-15 14:04:04.604826150 +0400
@@ -67,6 +67,7 @@
 	GeneralGroupchatUI *d = (GeneralGroupchatUI *)w;
 	PsiOptions::instance()->setOption("options.ui.muc.use-highlighting", d->ck_gcHighlights->isChecked());
 	PsiOptions::instance()->setOption("options.ui.muc.use-nick-coloring", d->ck_gcNickColoring->isChecked());
+	PsiOptions::instance()->setOption("options.ui.muc.use-hash-nick-coloring", d->ck_gcHashNickColoring->isChecked());

 	QStringList highlight;
 	int i;
@@ -96,6 +97,8 @@
 	d->ck_gcHighlights->setChecked( PsiOptions::instance()->getOption("options.ui.muc.use-highlighting").toBool() );
 	d->ck_gcNickColoring->setChecked( true );
 	d->ck_gcNickColoring->setChecked( PsiOptions::instance()->getOption("options.ui.muc.use-nick-coloring").toBool() );
+	d->ck_gcHashNickColoring->setChecked( true );
+	d->ck_gcHashNickColoring->setChecked( PsiOptions::instance()->getOption("options.ui.muc.use-hash-nick-coloring").toBool() );
 	d->lw_highlightWords->clear();
 	d->lw_highlightWords->addItems( PsiOptions::instance()->getOption("options.ui.muc.highlight-words").toStringList() );
 	d->lw_nickColors->clear();
